{
  "name": "M Rate COPA",
  "expression": [
    "VAR Fact_H =",
    "    SUMMARIZE (",
    "    ",
    "       FILTER( FACT_COPA,RELATED('Source Currency'[Currency Code])=\"ARS\"),",
    "        FACT_COPA[CRNCY_KEY],",
    "        'Date'[Calendar Month Begin Date],",
    "        \"X\", SELECTEDMEASURE ()",
    "    )",
    "VAR Fact_M =",
    "    SUMMARIZE (",
    "        FILTER(FACT_COPA,RELATED('Source Currency'[Currency Code]) <> \"ARS\"),",
    "        FACT_COPA[CRNCY_KEY],",
    "        FACT_COPA[POSTNG_DATE_INT_KEY],",
    "        \"X\", SELECTEDMEASURE ()",
    "    ) ",
    "      ",
    "    ",
    "    VAR H=",
    "     CALCULATE(",
    "        SUMX(",
    "            Fact_H,",
    "            [X]",
    "            * MINX(",
    "                FILTER(",
    "                    'Currency Conversion table',",
    "                    'Currency Conversion table'[Rate Effective To Date] >= 'Date'[Calendar Month Begin Date]",
    "                    && 'Currency Conversion table'[Rate Effective From Date] <= 'Date'[Calendar Month Begin Date]",
    "                    && FACT_COPA[CRNCY_KEY]= 'Currency Conversion table'[FROM_CRNCY_KEY]",
    "                    && 'Currency Conversion table'[Rate Type] = \"MovAvg\"",
    "                 ",
    "                ),",
    "                'Currency Conversion table'[EXCHG_RATE]",
    "            )",
    "        ),",
    "        ALL('Currency Conversion table'[Rate Effective To Date])",
    "    )",
    "            ",
    "            ",
    "            ",
    " VAR M=",
    "  CALCULATE (",
    "            SUMX (",
    "                Fact_M,",
    "                [X]",
    "                    * MINX (",
    "                        FILTER (",
    "                            'Currency Conversion table',",
    "                            'Currency Conversion table'[RATE_EFF_FROM_DTE_INT_KEY] <= FACT_COPA[POSTNG_DATE_INT_KEY]",
    "                                && 'Currency Conversion table'[RATE_EFF_TO_DTE_INT_KEY] >= FACT_COPA[POSTNG_DATE_INT_KEY]",
    "                                && FACT_COPA[CRNCY_KEY] = 'Currency Conversion table'[FROM_CRNCY_KEY]",
    "                                && 'Currency Conversion table'[Rate Type] = \"M\"",
    "                        ),",
    "                        'Currency Conversion table'[EXCHG_RATE]",
    "                    )",
    "            ),",
    "            ALL ( 'Currency Conversion table'[Rate Effective To Date] )",
    "            ",
    "            )",
    "    ",
    "    VAR R = H + M",
    "    ",
    "    ",
    "RETURN",
    "  ",
    "   R"
  ]
}
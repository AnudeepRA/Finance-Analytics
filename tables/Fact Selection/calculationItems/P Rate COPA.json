{
  "name": "P Rate COPA",
  "expression": [
    "VAR Fact_H =",
    "    SUMMARIZE (",
    "    ",
    "       FILTER( FACT_COPA,RELATED(DIM_SOURCE_CRNCY[Currency Code])=\"ARS\"),",
    "        FACT_COPA[CRNCY_KEY],",
    "        DIM_DATE[Calendar Month Begin Date],",
    "        \"X\", SELECTEDMEASURE ()",
    "    )",
    "VAR Fact_P =",
    "    SUMMARIZE (",
    "        FILTER(FACT_COPA,RELATED(DIM_SOURCE_CRNCY[Currency Code]) <> \"ARS\"),",
    "        FACT_COPA[CRNCY_KEY],",
    "        FACT_COPA[POSTNG_DATE_INT_KEY],",
    "        \"X\", SELECTEDMEASURE ()",
    "    ) ",
    "    ",
    "",
    "",
    "VAR myDate =",
    "    MAX ( DIM_CRNCY_CVRSN[Rate Effective To Date] )",
    "    ",
    "VAR H =",
    "    CALCULATE (",
    "        SUMX (",
    "            Fact_H,",
    "            [X]",
    "                * MINX (",
    "                    FILTER (",
    "                        DIM_CRNCY_CVRSN,",
    "                        DIM_CRNCY_CVRSN[Rate Effective To Date] >= DIM_DATE[Calendar Month Begin Date]",
    "                            && DIM_CRNCY_CVRSN[Rate Effective From Date] <= DIM_DATE[Calendar Month Begin Date]",
    "                            && FACT_COPA[CRNCY_KEY] = DIM_CRNCY_CVRSN[FROM_CRNCY_KEY]",
    "                            && DIM_CRNCY_CVRSN[Rate Type] = \"MovAvg\"",
    "                         ",
    "                    ),",
    "                    DIM_CRNCY_CVRSN[EXCHG_RATE]",
    "                )",
    "        ),",
    "        ALL ( DIM_CRNCY_CVRSN[Rate Effective To Date] )",
    "    )",
    "VAR P =",
    "    CALCULATE (",
    "        SUMX (",
    "            Fact_P,",
    "            [X]",
    "                * MINX (",
    "                    TOPN (",
    "                        1,",
    "                        FILTER (",
    "                            DIM_CRNCY_CVRSN,",
    "                            DIM_CRNCY_CVRSN[Rate Effective From Date] <= myDate",
    "                                && FACT_COPA[CRNCY_KEY] = DIM_CRNCY_CVRSN[FROM_CRNCY_KEY]",
    "                                && DIM_CRNCY_CVRSN[Rate Type] = \"P\"",
    "                             ",
    "                        ),",
    "                        DIM_CRNCY_CVRSN[Rate Effective From Date]",
    "                    ),",
    "                    DIM_CRNCY_CVRSN[EXCHG_RATE]",
    "                )",
    "        ),",
    "        ALL ( DIM_CRNCY_CVRSN[Rate Effective To Date] )",
    "    )",
    "VAR R = P + H",
    "RETURN",
    "   R"
  ]
}